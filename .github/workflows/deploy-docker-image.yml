name: 'Merge Template'

on:
  release:
    types: [published]

jobs:
  pre-check:
    runs-on: ubuntu-latest
    outputs:
      run_pipeline: ${{ steps.check.outputs.run_pipeline }}
    steps:
      - id: check
        run: |
          if [[ "${{ github.event.release.name }}" == *deploy* ]]; then
            echo "run_pipeline=true" >> $GITHUB_OUTPUT
          else
            echo "run_pipeline=false" >> $GITHUB_OUTPUT
          fi
  format:
    needs: pre-check
    if: needs.pre-check.outputs.run_pipeline == 'true'
    uses: ./.github/workflows/code-formatter.yml
  unit-tests:
    needs: pre-check
    if: needs.pre-check.outputs.run_pipeline == 'true'
    uses: ./.github/workflows/testing-unit.yml
  E2E:
    needs: pre-check
    if: needs.pre-check.outputs.run_pipeline == 'true'
    uses: ./.github/workflows/testing-e2e.yml
  check:
    needs: pre-check
    if: needs.pre-check.outputs.run_pipeline == 'true'
    uses: ./.github/workflows/testing-svelte-check.yml
  docker-compose:
    needs: pre-check
    if: needs.pre-check.outputs.run_pipeline == 'true'
    uses: ./.github/workflows/docker-compose-test.yml

  push-docker-image:
    runs-on: ubuntu-latest
    needs: [format, unit-tests, E2E, check, docker-compose]
    steps:
      - name: Log in to Gitea Registry
        uses: docker/login-action@v3.5.0
        with:
          registry: ${{ secrets.GITEA_REGISTRY_URL }}
          username: ${{ secrets.GITEA_REGISTRY_USER }}
          password: ${{ secrets.GITEA_REGISTRY_PWD }}

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Retrieve credentials and push image
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          REPOSITORY_NAME=$(basename $GITHUB_REPOSITORY)
          IMAGE_NAME=${{ secrets.GITEA_REGISTRY_URL }}/$REPOSITORY_NAME

          echo "TAG is '$TAG'"

          echo "Building image..."
          docker build -t $IMAGE_NAME:latest .

          echo "Tagging image with release tag..."
          docker tag $IMAGE_NAME:latest $IMAGE_NAME:$TAG

          echo "Pushing latest tag..."
          docker push $IMAGE_NAME:latest

          echo "Pushing release tag..."
          docker push $IMAGE_NAME:$TAG