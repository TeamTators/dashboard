name: docker-compose-test

on:
  workflow_call:
  push:
    branches:
      - '*'
      - '!deploy'
      - '!gh-pages'

permissions:
  contents: read

jobs:
  docker-compose-tests:
    # this has a chance of infinite loop if we write a test wrong, timeout should catch it eventually.
    timeout-minutes: 5
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: v22.12.0

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      - name: Install Dependencies
        run: pnpm i

      - name: Initialize .env
        run: |
          echo "DB_USER=test_user" > .env
          echo "DB_PASS=test" >> .env
          echo "DB_NAME=test" >> .env
          echo "DB_HOST=localhost" >> .env
          echo "DB_PORT=5432" >> .env

      - name: Set up Postgres
        run: |
          docker-compose up -d db
          docker exec db psql -U admin -c "CREATE ROLE test_user WITH LOGIN PASSWORD 'test';"
          docker exec db psql -U admin -c "CREATE DATABASE test WITH OWNER test_user;"
          docker exec db psql -U admin -c "GRANT admin TO test_user;"
          pnpm db:migrate
          pnpm db:push --force
          docker-compose stop

      - name: Start App
        run: |
          docker-compose up -d app
          docker-compose logs -f app
          pnpm test:integration

      - name: Stop Application
        run: docker-compose down -v
